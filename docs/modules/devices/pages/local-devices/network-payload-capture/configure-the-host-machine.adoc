= Configure the Mac mini host for network payload capture
:navtitle: Configure Mac mini host

Learn how to configure your local Cloud or Standalone Kobiton Mac mini host so you and your team can use network payload capture during a xref:manual-testing:local-devices/capture-network-payload-data.adoc[manual session] or xref:automation-testing:local-devices/capture-network-payload-data.adoc[automation session].

[#_before_you_start]
== Before you start

You'll need to:

* Access the Mac mini host as the *deviceconnect* user for all the operations below.
* Make sure the Mac mini is connected to a network that satisfies the network requirements for Network Payload Capture before proceeding.

== Mac mini with Apple Silicon: Install Rosetta

[NOTE]
This section is only required for Mac mini host with Apple Silicon.

Open *Terminal* on the Mac mini host.

Run the below command to install Rosetta:

[source,shell]
softwareupdate --install-rosetta --agree-to-license

== Modify the `dc.ini` file

Edit the `dc.ini` file from the location `/usr/local/deviceconnect/` using any text editor (Create a backup of the `dc.ini` file prior to making updates).

Check if the below content exists in the file. Otherwise, append the content to the end of the file.

[IMPORTANT]

Make sure the below is under the `[set]` tag, not `[config]`.

[source,plaintext]
----
# Payload Capture
DeviceNetworkCapture.NetworkCaptureProxyHost=[deviceConnect IP address]
DeviceNetworkCapture.NetworkCaptureProxyIsLocal=true
DeviceNetworkCapture.NetworkCaptureProxyControlPort=8225
DeviceNetworkCapture.NetworkCaptureProxyHttpListenPort=8080
DeviceNetworkCapture.TimeoutConnectSeconds=10
DeviceNetworkCapture.Trace=true
DeviceNetworkCapture.ExternalDebugLog=false
----

Replace `[deviceConnect IP address]` with the local IP address of the Mac mini host.

[NOTE]
If the Mac mini is connected to more than one networks at the same time (for example, both Ethernet and Wi-Fi), make sure `[deviceconnect IP address]` is the IP address obtained from the interface that is connected to the same network as the mobile devices.

You can retrieve the local IP address(es) of the Mac mini by either:

* Navigating to *Settings > Network > Ethernet* or *Wi-Fi* and copying the IP address value. For Wi-Fi, click the *Detailsâ€¦* button next to the connected network to view the IP.

* Opening *Terminal*, then entering the `ifconfig` command. The IP address is usually under the `en0` entry (for Etheret) or `en1` entry (for Wi-Fi), next to `inet`.

+

.example of ifconfig command
[source,shell]
----
en0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
	options=50b<RXCSUM,TXCSUM,VLAN_HWTAGGING,AV,CHANNEL_IO>
	ether **:**:**:**:ad:a1
	inet6 fe80::140b:b7b:e8a0:c90f%en0 prefixlen 64 secured scopeid 0x4
	inet 192.168.50.86 netmask 0xffffff00 broadcast 192.168.50.255

en1: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
	options=6460<TSO4,TSO6,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>
	ether **:**:**:**:**:19
	inet6 fe80::1834:8865:82ea:2b5c%en1 prefixlen 64 secured scopeid 0x7
	inet 192.168.50.118 netmask 0xffffff00 broadcast 192.168.50.255
----

Save the file, then xref:device-lab-management:deviceConnect/restart-deviceconnect-services.adoc[restart services] on the Mac mini host to apply the changes.

[NOTE]
====
If you are only hosting Android devices, you can move on to configure your xref:devices:local-devices/network-payload-capture/configure-an-android-device.adoc[Android device] now. The next steps are only required for hosting iOS devices.
====

== Option 1: Establish trusted ssh connection and install Automation Tools

[#_check_for_an_existing_ssh_key]
=== Check for an existing SSH key

In the terminal, open the `.ssh` directory, then list the contents of the directory.

[source,shell]
----
cd ~/.ssh && ls -a
----

If you see an `id_rsa` file, go to xref:_modify_the_ssh_key[]. Otherwise, continue to the next section.

[#_generate_a_new_ssh_key]
=== Generate a new SSH key

In the `.ssh` directory, enter the following command:

[source,shell]
----
ssh-keygen -t rsa
----

Leave the passphrase empty and press *Enter*.

[source,shell]
----
> Enter passphrase (empty for no passphrase): [Leave empty]
> Enter same passphrase again: [Leave empty]
----

Now you're ready to xref:_modify_the_ssh_key[modify the SSH key].

[#_modify_the_ssh_key]
=== Modify the SSH key

In the `.ssh` directory, copy the contents from your `id_rsa` public key into the `authorized_keys` file.

[source,shell]
----
cat id_rsa.pub >> ./authorized_keys
----

[NOTE]
If an `authorized_keys` file doesn't exist, one will be automatically created.

Login using your SSH key. If prompted to _trust this connection_, type *yes* and press *Enter*.

[source,shell]
----
ssh 127.0.0.1
----

After you're successfully logged in, exit the SSH session, then restart the Mac mini host.

[source,shell]
----
exit && sudo shutdown -r now
----

== Set up Apple Configurator

Download and install link:https://apps.apple.com/app/id1037126344[Apple Configurator] on the Mac mini host.

Open Apple Configurator. In the menu bar, select *Apple Configurator 2*, then select *Install Automation Tools*:

image:devices:apple-configurator-install-automation-tools.png[width="", alt=""]

Select *Install*, then enter your admin password. Once the automation tools are installed, you can close Apple Configurator since it doesn't need to be open for network payload capture.

== Next steps

Configure the xref:devices:local-devices/network-payload-capture/configure-an-android-device.adoc[Android] and xref:devices:local-devices/network-payload-capture/configure-an-ios-device.adoc[iOS devices] for network payload capture.
