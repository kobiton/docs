= Add iOS device

== Before you start

* Follow this guide to xref:ios-devices/prepare-ios-device.adoc[prepare the device].

* Find the UDID of the device and note it down.

* Make sure the Mac mini host has the Xcode version that is compatible with the iOS/iPadOS version of the device. Refer to the https://developer.apple.com/support/xcode/[Apple Xcode support page,window=read-later] for more information.

== Connect Cambrionix hub to the host

[NOTE]
Skip this step if the Mac mini host or GEM already has a Cambrionix hub connected.

Make sure you use a supported model of xref:deviceConnect/hardware-requirements-for-deviceconnect.adoc[Cambrionix hub].

Connect the Cambrionix hub to a power source. The power LED indicator of the Cambrionix hub should turn on.

For Standard mode, connect the Mac mini to the **host** port of the hub.

For Lightning mode, connect the Graphic Extension Manager (GEM) to the **host** port of the hub. Make sure you connect the Cambrionix hub to the blue USB 3.0 port on the GEM.

Refer to the hub model’s user manual from Cambrionix for the exact host port location.

See below for an example of the SuperSync15 with the Host port visible.

image::device-lab-management:device-lab-management-add-android-supersync15.PNG[width=600, alt="SuperSync15 with the Host port visible"]

[#network-requirements-wifi-pairing]
== Connect the Mac mini host and devices to a network that supports mDNS and Wi-Fi pairing

[IMPORTANT]
This section is only required for *iOS/iPadOS 17.0 to 17.3.1* devices with *Lightning mode* configuration.

Prepare a network that satisfies the following requirements:

* _mDNS UDP Messages_: The devices will broadcast mDNS UDP messages that the Mac mini must be capable of receiving. This communication is facilitated via the UDP port 5353.

* _TCP Connection_: Processes housed on the Mac mini should have the capability to initiate a TCP connection to an iOS device. It's important to note that this connection uses one of the IPv6 addresses and port numbers that the device advertises. Since these addresses and port numbers aren't static and can change over time, flexibility in the network configuration is crucial.

* _Optimal Setup_: The most straightforward way to implement this setup is by positioning both the Mac mini and the iOS devices on the same subnet within the same Wi-Fi network. Such an arrangement is compatible with the default configurations of a majority of network equipment, ensuring minimal overhead in terms of setup. However, if your network differs, adjustments can be made at the router level to support the necessary UDP broadcasts and TCP connections.

When the network is ready, connect both the devices and the Mac mini host to this network.

[NOTE]
If the network requirements cannot be met, use *Standard mode* to host the iOS 17.0 to 17.3.1 devices instead. You will need at least 1 additional Mac mini to host in Standard mode.

== Connect the device to the host

Make sure you have properly xref:ios-devices/prepare-ios-device.adoc[prepared the device] for hosting.

For Standard mode, connect the mobile device to the Cambrionix hub attached to the Mac mini host.

For Lightning mode with iOS 16 and below, connect the mobile device to the Cambrionix hub attached to the GEM.

For Lightning mode with iOS 17 and above, connect the device to one of the USB ports of the Mac mini host to establish trust pairing first, then follow the next section before connecting the device to the Cambrionix hub attached to the GEM.

Check the device to see if it is charging after connecting. If it is not charging, the USB cable might be malfunctioning, or the Cambrionix hub is not connected to a power source.

[#_import_certificates_and_provisioning_profiles]
== Import certificates and provisioning profiles

Follow xref:ios-devices/import-ios-signing-certificates-and-provisioning-profiles.adoc[this section,window=read-later] to import signing certificates and provisioning profiles to the Mac mini host. The signing certificates and provisioning profiles are needed for:

* Provisioning the Kobiton control agent app to install it on all devices that are hosted by the Mac mini host (for deviceConnect). This is *required*.

* Re-signing applications uploaded to the Kobiton portal to install them on the devices (for deviceShare). This is only required if you use the Kobiton re-signing service.

Skip this section if the certificates and provisioning profiles have already been imported. If you are unsure, you can always xref:_verify_device_is_available_in_kobiton[verify the certificates and provisioning profiles] after connecting the devices.

== Establish trust pairing between the device and the host

Access the Mac mini host directly or via screen sharing.

The steps to establish trust pairing vary between iOS 16 and below and iOS 17 and above.

=== iOS 16 and below

[NOTE]
The steps in this section apply to both Standard and Lightning mode.

The device needs to be trusted by the system it is plugged into:

* For Lightning mode, that is the GEM (Dell server).
* For Standard mode, that is the Mac mini host.

After plugging the device to the appropriate system, check the device screen. Tap *Trust* on the *Trust this computer* popup:

image::device-lab-management:device-lab-management-ios-add-ios-trust-this-computer-trust.PNG[width=300,alt="Trust this computer popup, clicking Trust"]

Open *Finder* in the Mac mini host, select the connected device name, and choose *Trust*. If the device appears in Finder but there is no _Trust_ button, skip this step.

image::device-lab-management:device-lab-management-ios-add-ios-trust-iphone-trust.PNG[width=600,alt="Trust this iphone window, clicking Trust"]

Unplug the device, then plug it in again. Wait until the device screen changes as shown below before continuing. There will also be an *automation running* overlay above the device screen.

image::device-lab-management:device-lab-management-add-ios-screen-changes-to-blue.PNG[width=300, alt="device screen changes and shows Kobiton name and logo"]

=== iOS 17 and above

[IMPORTANT]
.Note for air-gapped Mac mini hosts (no Internet access)
====
To control the iOS devices, deviceConnect needs to mount a *Developer Disk Image* (DDI), which is a `.dmg` archive included with Xcode that contains executables and other files needed by Xcode to support debugging and testing on iOS devices.

For iOS 17 and later, rather than Xcode providing a different DDI for every iOS version and device architecture, there is a generic DDI that Xcode must "personalize" for each device. The personalization process requires an Internet connection, as Xcode must use Apple's notarization servers to sign the personalized image. Without an Internet connection, Xcode can't personalize a DDI.

If the Mac mini host does not have Internet connection, follow the section xref:#preload-ddi-air-gapped[preload DDI for air-gapped Mac mini] before continuing with this section.

====

Follow the appropriate steps based on whether you are using Standard or Lightning mode.

[tabs]
====

Standard Mode::
+
--

The device needs to be trusted by the Mac mini host it is plugged into.

After plugging the device into the Mac mini host, open *Xcode* then navigate to *Window → Devices and Simulators*. Do this before continuing to the next step.

When the *Trust this computer* prompt on the device screen appears, tap *Trust*. If the prompt reappears, tap *Trust* again until there is no more prompt.

image::device-lab-management:device-lab-management-ios-add-ios-standard-lightning-trust.PNG[width=300,alt="Standard Mode. Trust This Computer popup, clicking Trust"]

--

Lightning mode - iOS 17.0 to 17.3.1::
+
--

The device needs to be trusted by both of the following:

* The Mac mini host that is paired with the GEM (Dell server)
* The GEM it is plugged into.

Connect the devices and the Mac mini host to a network that xref:#network-requirements-wifi-pairing[satisfies the requirements].

Make sure you connect the device *to the Mac mini host* first.

Open Xcode on the Mac mini host, then navigate to *Window → Devices and Simulators*. Do this before continuing to the next step.

When the *Trust this computer* prompt on the device screen appears, tap *Trust*. If the prompt reappears, tap *Trust* until there is no more prompt.

image::device-lab-management:device-lab-management-ios-add-ios-standard-lightning-trust.PNG[width=300,alt="Lightning Mode. Trust This Computer popup, clicking Trust"]

In the Mac mini host’s screen, under the *Devices* tab of the *Devices and Simulators* screen, the iOS 17 devices should show up with a yellow warning message like the one below:

image::device-lab-management:device-lab-management-ios-add-ios-device-and-simulator.PNG[width=600,alt="iOS 17 in Devices and Simulators"]

Wait for the debug symbol transfer to finish, then unplug the device from the Mac mini host and plug it into the Cambrionix hub connected to the GEM.

The *Trust this computer* prompt will appear again to establish trust pairing with the GEM. Tap *Trust*.

In Xcode’s _Devices and Simulators_, the iOS 17 devices will now have a globe icon next to it like below:

image::device-lab-management:device-lab-management-ios-add-ios-xcode-device-and-simulator.PNG[width=300,alt="Devices, iphone is connected notification"]

--

Lightning mode - iOS 17.4 and above::
+
--

The device needs to be trusted by the GEM (Dell server) it is plugged into.

After plugging the device into the Cambrionix hub connected to the GEM, the *Trust This Computer* prompt appears. Tap *Trust*.

image::device-lab-management:device-lab-management-ios-add-ios-standard-lightning-trust.PNG[width=300,alt="Lightning Mode. Trust This Computer popup, tapping Trust"]

--

====

Wait until the device screen changes to the below before continuing. There will also be an *automation running* overlay above the device screen (not shown in screenshot).

image::device-lab-management:device-lab-management-add-ios-screen-changes-to-blue.PNG[width=300, alt="device screen changes and shows Kobiton name and logo"]

[#preload-ddi-air-gapped]
=== Preload DDI for air-gapped Mac mini hosts

[NOTE]
This section is only required for Mac mini hosts with no Internet access with iOS 17 and above devices.

Access any macOS machine with Internet access. This will be referred to as the Internet Mac.

[NOTE]
Kobiton software, such as deviceConnect and deviceShare, does not need to be installed on the Internet Mac.

Ensure *Xcode* is installed on the Internet Mac. Make sure the Xcode version is compatible with the iOS 17 device.

[IMPORTANT]
Make sure the Xcode version on the Internet Mac *is the same or greater* than the version on the Mac mini host to transfer the DDI to.

Unplug the iOS 17 device from the air-gapped Mac (Standard mode) or the GEM (Lightning mode) and connect it to the Internet Mac.

Open Xcode.

Tap Trust in the *Trust this computer* popup on the iOS 17 device. The *Trust this computer* prompts will reappear, tap *Trust* again. After this, there should be no more *Trust* prompts.

In the Xcode menu bar, select *Window → Devices and Simulators*. Select the iOS 17 device under the *Devices* tab.

The `Copying shared cache symbols...` message appears. Wait for this process to complete and the message to clear.

image::device-lab-management:device-lab-management-ios-add-ios-copying-shared-cache-symbols.PNG[width=600,alt="Copying shared cache symbols"]

Unplug the device from the Internet Mac.

Repeat the above processes for all iOS/iPadOS 17 and later devices to be hosted on the air-gapped Mac mini.

Open *Finder* on the Internet Mac. Press *Shift + Command + G* on the keyboard, then input the following path depending on the version of Xcode:

* `/Library/Developer/DeveloperDiskImages` (Xcode 16 and above)

* `~/Library/Developer/DeveloperDiskImages` (Xcode below 16)

Copy the 2 files `iOS_DDI-version.plist` and `iOS_DDI.dmg` to the *air-gapped Mac mini* that will host the iOS/iPadOS 17 and later devices. Put the copied file into the following folder on the air-gapped Mac mini:

* `/Library/Developer/DeveloperDiskImages` if the current Xcode version is 16 or above.

* ``~/Library/Developer/DeveloperDiskImages ``if the current Xcode version is below 16.

Repeat the above process for all air-gapped Mac mini hosts with iOS/iPadOS 17 and later devices.

Continue with connecting iOS 17 and above devices to the air-gapped Mac mini hosts or the GEM.

[IMPORTANT]
Apple has not published whether the personalized DDI will expire or how long it will last in an air-gapped environment. If connection errors occur and other troubleshooting steps do not resolve the issue, the personalized DDI may be expired, and you will need to repeat this process.

[#_verify_device_is_available_in_kobiton]
== Verify device is available in Kobiton

Open Chrome on the Mac mini, then open *localhost* and log in.

Navigate to *Devices*. The connected device displays as *Available*.

image::device-lab-management:device-lab-management-ios-add-ios-localhost-system-ios-device-available.PNG[width=600,alt="Verifying device is avaiable on Kobiton"]

[IMPORTANT]
====

If you see the *deviceControl* warning or the error under the device's name with either of the below messages, follow xref:ios-devices/import-ios-signing-certificates-and-provisioning-profiles.adoc#_resolve_common_errors_with_certificates_and_provisioning_profiles[this section,window=read-later] to troubleshoot the issue and generate and/or import the correct certificates and provisioning profiles.

* _Device is not associated with any valid installed provisioning profile._

* _No provisioned deviceControl or signing profiles are available. iOS devices will not be usable._


====

Still in Chrome, open the Kobiton web portal and log in using an account with *ADMIN* role.

Select the profile picture and choose *Settings*, then choose *Device Management*.

In the search bar, enter the device’s UDID and select Enter to filter.

The device should appear in the filter result. If the state of the device is *Utilizing*, it is being cleaned up. Wait about 2-3 minutes for the cleanup to complete.

When the cleanup is done, the device state becomes *Online* and the **Launch** button is available. Select it to launch a Manual session on the device.

image::device-lab-management:device-lab-management-ios-add-ios-kobiton-device-management-launch.png[width=1200,alt="Kobiton portal, Launching device from Device Management"]

In the Manual session, try the following to verify if the device is working properly:

* xref:manual-testing:device-controls.adoc[Navigate around, window=_blank].

* xref:manual-testing:install-an-app.adoc[Install an app, window=_blank].

* Browse the web (if the device has a Wi-Fi connection).

* xref:manual-testing:device-controls.adoc#_speedometer[Enable Lightning mode, window=_blank] (if the device is configured for Lightning mode).

If all the above works, you have successfully added the device.