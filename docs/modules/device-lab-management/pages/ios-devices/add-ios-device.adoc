= Add iOS device

== Before you start

* Follow this guide to xref:ios-devices/prepare-ios-device.adoc[prepare the device].

* Find the UDID of the device and note it down.

* Make sure the Mac mini host has the Xcode version that is compatible with the iOS/iPadOS version of the device.

== Connect Cambrionix hub to the host

[NOTE]
Skip this step if the Mac mini host or GEM already has a Cambrionix hub connected.

Make sure you use a supported model of xref:deviceConnect/hardware-requirements-for-deviceconnect.adoc[Cambrionix hub].

Connect the Cambrionix hub to a power source. The power LED indicator of the Cambrionix hub should turn on.

For Standard mode, connect the Mac mini to the **host** port of the hub.

For Lightning mode, connect the Graphic Extension Manager (GEM) to the **host** port of the hub. Make sure you connect the Cambrionix hub to the blue USB 3.0 port on the GEM.

Refer to the hub model’s user manual from Cambrionix for the exact host port location.

See below for an example of the SuperSync15 with the Host port visible.

image::device-lab-management:device-lab-management-add-android-supersync15.PNG[width=600, alt="SuperSync15 with the Host port visible"]

== Connect the device to the host

Make sure you have properly xref:ios-devices/prepare-ios-device.adoc[prepared the device] for hosting on Kobiton.

For Standard mode, connect the mobile device to the Cambrionix hub attached to the Mac mini host.

For Lightning mode with iOS 16 and below, connect the mobile device to the Cambrionix hub attached to the GEM.

For Lightning mode with iOS 17 and above, connect the device to one of the USB ports of the Mac mini host to establish trust pairing first, then follow the next section before connecting the device to the Cambrionix hub attached to the GEM.

Check the device to see if it is charging after connecting. If it is not charging, the USB cable might be malfunctioning, or the Cambrionix hub is not connected to a power source.

== Establish trust pairing between the device and the host

Access the Mac mini host directly or via screen sharing.

The steps to establish trust pairing vary between iOS 16 and below and iOS 17 and above.

=== iOS 16 and below

[NOTE]
The steps in this section apply to both Standard and Lightning mode.

Check the device screen. Tap **Trust** on the Trust this computer popup:

image::device-lab-management:device-lab-management-ios-add-ios-trust-this-computer-trust.PNG[width=300,alt="Trust this computer popup, clicking Trust"]

Open **Finder** in the Mac mini host, select the connected device name, and choose **Trust**.

image::device-lab-management:device-lab-management-ios-add-ios-trust-iphone-trust.PNG[width=600,alt="Trust this iphone window, clicking Trust"]

Unplug the device, then plug it in again. Wait until the device screen changes to the below before continuing (NOTE: there will also be an *automation running* overlay above the device screen):

image::device-lab-management:device-lab-management-add-android-screen-changes-to-blue.PNG[width=300, alt="device screen changes and shows Kobiton name and logo"]

=== iOS 17 and above

[IMPORTANT]
.Note for air-gapped Mac mini hosts (no Internet access)
====
To control the iOS devices, deviceConnect needs to mount a *Developer Disk Image* (DDI), which is a `.dmg` archive included with Xcode that contains executables and other files needed by Xcode to support debugging and testing on iOS devices.

For iOS 17 and later, rather than Xcode providing a different DDI for every iOS version and device architecture, there is a generic DDI that Xcode must "personalize" for each device. The personalization process requires an Internet connection, as Xcode must use Apple's notarization servers to sign the personalized image. Without an Internet connection, Xcode can't personalize a DDI.

If the Mac mini host does not have Internet connection, follow the section xref:#preload-ddi-air-gapped[preload DDI for air-gapped Mac mini] before continuing with this section.

====

Follow the appropriate steps based on whether you are using Standard or Lightning mode.

[tabs]
====

Standard Mode::
+
--

Open Xcode on the Mac mini host, then navigate to **Window → Devices and Simulators**. Do this before continuing to the next step.

The Trust *this computer* prompt on the device screen appears, tap **Trust**.

image::device-lab-management:device-lab-management-ios-add-ios-standard-lightning-trust.PNG[width=300,alt="Standard Mode. Trust This Computer popup, clicking Trust"]

The Trust *this computer* prompts will reappear, tap **Trust** again. This time there should be no more **Trust** prompts.

--

Lightning mode::
+
--

Open Xcode on the Mac mini host, then navigate to **Window → Devices and Simulators**. Do this before continuing to the next step.

Make sure you connect the device **to the Mac mini host** first.

The Trust *this computer* prompt on the device screen appears, tap **Trust**.

image::device-lab-management:device-lab-management-ios-add-ios-standard-lightning-trust.PNG[width=300,alt="Lightning Mode. Trust This Computer popup, clicking Trust"]

In the Mac mini host’s screen, under the **Devices** tab of the **Devices and Simulators** screen, the iOS 17 devices should show up with a yellow warning message like the one below:

image::device-lab-management:device-lab-management-ios-add-ios-device-and-simulator.PNG[width=600,alt="iOS 17 in Devices and Simulators"]

Unplug the device from the Mac mini host and plug it into the Cambrionix hub connected to the GEM.

The *Trust this computer* prompts will reappear, tap **Trust** again. This time there should be no more **Trust** prompts.

In Xcode’s Devices and Simulators, the iOS 17 devices will now have a globe icon next to it like below:

image::device-lab-management:device-lab-management-ios-add-ios-xcode-device-and-simulator.PNG[width=300,alt="Devices, iphone is connected notification"]

--

====

Wait until the device screen changes to the below before continuing. There will also be an *automation running* overlay above the device screen (not shown in screenshot).

image::device-lab-management:device-lab-management-add-android-screen-changes-to-blue.PNG[width=300, alt="device screen changes and shows Kobiton name and logo"]

[#preload-ddi-air-gapped]
=== Preload DDI for air-gapped Mac mini hosts

[NOTE]
This section is only required for Mac mini hosts with no Internet access with iOS 17 and above devices.

Access any MacOS machine with Internet access. This will be referred to as the Internet Mac.

Ensure Xcode is installed on the Internet Mac. Make sure the Xcode version is compatible with the iOS 17 device.

[NOTE]
Kobiton software, such as deviceConnect and deviceShare, does not need to be installed on the Internet Mac.

Unplug the iOS 17 device from the air-gapped Mac (Standard mode) or the GEM (Lightning mode) and connect it to the Internet Mac.

Open Xcode.

Tap Trust in the **Trust this computer** popup on the iOS 17 device. The **Trust this computer** prompts will reappear, tap **Trust** again. After this, there should be no more **Trust** prompts.

In the Xcode menu bar, select **Window → Devices and Simulators**. Select the iOS 17 device under the **Devices** tab.

The `Copying shared cache symbols...` message appears. Wait for this process to complete and the message to clear.

image::device-lab-management:device-lab-management-ios-add-ios-copying-shared-cache-symbols.PNG[width=600,alt="Copying shared cache symbols"]

Unplug the device from the Internet Mac.

Continue with connecting iOS 17 and above devices to the air-gapped Mac mini hosts.

[IMPORTANT]
Apple has not published whether the personalized DDI will expire or how long it will last in an air-gapped environment. If connection errors occur and other troubleshooting steps do not resolve the issue, the personalized DDI may be expired, and you will need to repeat this process.

== Import certificates and provisioning profiles to the Mac mini host



== Verify device is available in Kobiton

Open Chrome on the Mac mini, then open *localhost* and log in.

Navigate to **Devices**. The connected device displays as **Available**.

image::device-lab-management:device-lab-management-ios-add-ios-localhost-system-ios-device-available.PNG[width=600,alt="Verifying device is avaiable on Kobiton"]

Still in Chrome, open the Kobiton web portal and log in using an account with ADMIN role.

Select the profile picture and choose **Settings**, then choose **Device Management**.

In the search bar, enter the device’s UDID and select Enter to filter.

The device should appear in the filter result. If the state of the device is *Utilizing*, it is being cleaned up. Wait about 2-3 minutes for the cleanup to complete.

When the cleanup is done, the device state becomes *Online* and the **Launch** button is available. Select it to launch a Manual session on the device.

image::device-lab-management:device-lab-management-ios-add-ios-kobiton-device-management-launch.png[width=1200,alt="Kobiton portal, Launching device from Device Management"]

In the Manual session, try the following to verify if the device is working properly:

* xref:manual-testing:device-controls.adoc[Navigate around, window=_blank].

* xref:manual-testing:install-an-app.adoc[Install an app, window=_blank].

* Browse the web (if the device has a Wi-Fi connection).

* xref:manual-testing:device-controls.adoc#_speedometer[Enable Lightning mode, window=_blank] (if the device is configured for Lightning mode).

If all the above works, you have successfully added the device.