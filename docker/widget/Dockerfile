# Description: Dockerfile for building the search widget, which is integrated within Kobiton portal. This widget allows
#              users to navigate to documention site, API docs, etc. conveniently.
#              Â© 2024 Kobiton Inc.
# Last Modified: 2024-03-26.
# Dependencies: node:20-alpine, nginx:alpine.
# Usage: docker buildx build --platform linux/amd64 -f ./docker/widget/Dockerfile -t portal-help --progress=plain .
#        docker run -p 8000:80 portal-help
# Notes: This Dockerfile is used to build the search widget.
#        It uses the nginx:alpine image to serve the static files generated by the build process.
#        The build process is done in a separate image to reduce the size of the final image.
#        The final image is 95.38MB.
# ==============================================================================================================
# Stage 1: Build the widget site.
FROM node:20-alpine AS builder

ENV KOBITON_ENVIRONMENT=standalone

RUN apk update && apk upgrade && apk add --virtual .build-deps \
    bash \
    git \
    openssl

RUN mkdir -p /home/privilege/app
WORKDIR /home/privilege/app

COPY . /home/privilege/app

RUN /bin/bash ./scripts/build.sh

# Stage 2: Serve the static files using nginx.
FROM nginx:alpine

ENV KOBITON_ENVIRONMENT=standalone
ENV KOBITON_STANDALONE_API_V2_DOCS_URL="localhost:8001"
ENV KOBITON_STANDALONE_DOCS_V2_URL="localhost:9090"

RUN apk update && apk upgrade && apk add --virtual .build-deps bash

RUN mkdir -p /widget
WORKDIR /widget

COPY --from=builder /home/privilege/app/build/widget /widget
COPY ./docker/widget/nginx.conf /etc/nginx
COPY ./docker/mime.types /etc/nginx
COPY ./scripts/replace-env-vars.sh .
COPY ./assets/js/mermaid.min.js ./_/js/vendor

EXPOSE 80

CMD /bin/bash ./replace-env-vars.sh . && nginx -g 'daemon off;'
