# Description: Dockerfile for building the documentation site.
#              Â© 2024 Kobiton Inc.
# Last Modified: 2024-03-26.
# Dependencies: node:20-alpine, nginx:alpine.
# Usage: docker buildx build --platform linux/amd64 -f ./docker/docs/Dockerfile -t documentation --progress=plain .
#        docker run -p 8001:80 documentation
# Notes: This Dockerfile is used to build the documentation site.
#        It uses the nginx:alpine image to serve the static files generated by the build process.
#        The build process is done in a separate image to reduce the size of the final image.
#        The final image is 109.66MB.
# ==============================================================================================================
# Stage 1: Build the documentation site.
FROM node:20-alpine AS builder

ENV KOBITON_ENVIRONMENT=standalone

RUN apk update && apk upgrade && apk add --virtual .build-deps \
    bash \
    git \
    openssl

RUN mkdir -p /home/privilege/app
WORKDIR /home/privilege/app

COPY . /home/privilege/app
RUN /bin/bash ./scripts/build.sh

# Stage 2: Serve the static files using nginx.
FROM nginx:alpine

# Only for local development.
#ENV KOBITON_ENVIRONMENT=standalone
#ENV KOBITON_STANDALONE_API_V2_DOCS_URL="localhost:8001"
#ENV KOBITON_STANDALONE_DOCS_V2_URL="localhost:9090"

RUN apk update && apk upgrade && apk add --virtual .build-deps bash

RUN mkdir -p /docs
WORKDIR /docs

COPY --from=builder /home/privilege/app/build/docs /docs
COPY ./docker/docs/nginx.conf /etc/nginx
COPY ./docker/mime.types /etc/nginx
COPY ./scripts/replace-env-vars.sh .
COPY ./assets/js/mermaid.min.js ./_/js/vendor

EXPOSE 80

CMD /bin/bash ./replace-env-vars.sh . && nginx -g 'daemon off;'
